<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;
use App\Models\Desa;

class InfrastrukturSeeder extends Seeder
{
    private $boundary = [];
    private $boundingBox = [];

    public function __construct()
    {
        // Official administrative boundary of Desa Somagede
        $this->boundary = [
            [-7.539919853210392, 109.557662963867188], [-7.539669990539551, 109.557189941406364],
            [-7.539480209350586, 109.556709289550781], [-7.539350032806396, 109.556381225585994],
            [-7.539289951324463, 109.55625152587902], [-7.539269924163818, 109.556137084960938],
            [-7.539249897003174, 109.555923461914062], [-7.539249897003174, 109.555686950683537],
            [-7.539229869842529, 109.55535888671875], [-7.539299964904728, 109.555030822753963],
            [-7.539330005645752, 109.554626464843807], [-7.539279937744084, 109.55419921875],
            [-7.539259910583439, 109.554122924804801], [-7.539179801940861, 109.553840637207031],
            [-7.539090156555176, 109.553657531738281], [-7.539050102233887, 109.553428649902344],
            [-7.538980007171631, 109.553222656249943], [-7.538899898529053, 109.552963256835994],
            [-7.538839817047119, 109.552780151367301], [-7.538770198822021, 109.552436828613395],
            [-7.538690090179443, 109.552078247070256], [-7.538619995117131, 109.551696777343693],
            [-7.538489818572998, 109.551033020019588], [-7.538320064544678, 109.550170898437443],
            [-7.538099765777531, 109.549278259277344], [-7.537960052490178, 109.548309326171875],
            [-7.537869930267334, 109.547431945800838], [-7.537779808044434, 109.546730041503849],
            [-7.537730216979924, 109.546112060546989], [-7.537650108337346, 109.545356750488395],
            [-7.537539958953801, 109.544158935546932], [-7.537419795989933, 109.543128967285156],
            [-7.537384033203068, 109.54288482666027], [-7.532677173614502, 109.54315185546875],
            [-7.529895305633545, 109.543388366699276], [-7.527790069580078, 109.543472290039176],
            [-7.526751518249455, 109.543281555175895], [-7.525720119476318, 109.542892456054801],
            [-7.525290012359619, 109.542594909667969], [-7.524598121643066, 109.542488098144645],
            [-7.523635387420597, 109.542495727539176], [-7.522838115692139, 109.542434692382869],
            [-7.520847797393799, 109.542366027832031], [-7.521033287048283, 109.542671203613395],
            [-7.52126932144165, 109.543098449706974], [-7.521622180938721, 109.543548583984375],
            [-7.521915912628174, 109.543807983398494], [-7.522338390350342, 109.544204711914176],
            [-7.522480487823486, 109.54441070556652], [-7.522586822509709, 109.544662475585938],
            [-7.522674560546818, 109.545028686523438], [-7.522700786590576, 109.545143127441463],
            [-7.522634983062744, 109.545471191406307], [-7.522423267364445, 109.545707702636776],
            [-7.522173881530705, 109.545867919921932], [-7.521759510040226, 109.546112060546989],
            [-7.521245002746582, 109.546424865722713], [-7.520788669586182, 109.546707153320426],
            [-7.520379543304443, 109.547012329101619], [-7.519827365875244, 109.547439575195426],
            [-7.519649028778076, 109.547531127929688], [-7.519171237945557, 109.547721862792969],
            [-7.51896858215332, 109.547813415527401], [-7.518703937530461, 109.547866821289006],
            [-7.518312931060791, 109.547973632812557], [-7.517908573150635, 109.548065185546818],
            [-7.517545223236084, 109.548126220703125], [-7.516915798187199, 109.548240661621207],
            [-7.515908718109131, 109.548408508300895], [-7.515831947326603, 109.548431396484489],
            [-7.515112400054875, 109.548652648925781], [-7.514426708221436, 109.548995971679801],
            [-7.513956069946232, 109.549278259277344], [-7.513771533966064, 109.549392700195256],
            [-7.513253211975098, 109.549835205078125], [-7.512797355651855, 109.550354003906193],
            [-7.512370586395207, 109.550933837890568], [-7.512190818786564, 109.551162719726562],
            [-7.512045383453369, 109.551338195800781], [-7.511899948120117, 109.551406860351619],
            [-7.51181173324585, 109.551429748535213], [-7.511714935302678, 109.551445007324332],
            [-7.511525630950928, 109.551391601562557], [-7.511395454406738, 109.551780700683651],
            [-7.511346817016602, 109.551994323730526], [-7.511316299438477, 109.552131652832031],
            [-7.510986804962101, 109.552978515625114], [-7.510879993438664, 109.553260803222656],
            [-7.510867595672551, 109.553421020507812], [-7.511094093322697, 109.553886413574276],
            [-7.511336803436222, 109.554313659668082], [-7.51154613494873, 109.554885864257926],
            [-7.51161003112793, 109.555107116699332], [-7.511616230010986, 109.555572509765625],
            [-7.511560916900635, 109.555854797363395], [-7.511103630065918, 109.556571960449276],
            [-7.51087570190424, 109.556823730468864], [-7.51051139831543, 109.557197570800895],
            [-7.510344982147217, 109.557495117187557], [-7.510058879852295, 109.558113098144588],
            [-7.509895324706974, 109.558532714843864], [-7.509845733642578, 109.558746337890568],
            [-7.509852409362793, 109.559005737304688], [-7.509858131408578, 109.55930328369152],
            [-7.509807586669865, 109.559471130371207], [-7.509657382965088, 109.559814453125057],
            [-7.509613037109318, 109.560142517089844], [-7.509621620178223, 109.560440063476676],
            [-7.509619235992432, 109.560897827148438], [-7.509579181671143, 109.561355590820369],
            [-7.509542942047119, 109.561706542968807], [-7.509411334991455, 109.562240600585938],
            [-7.509300708770752, 109.562637329101619], [-7.50927543640131, 109.562873840332088],
            [-7.509269714355469, 109.562973022460938], [-7.509268760681152, 109.563133239746037],
            [-7.509324550628662, 109.563392639160156], [-7.509352207183838, 109.563606262207088],
            [-7.509376049041748, 109.563728332519531], [-7.509395122528076, 109.564033508300895],
            [-7.50950288772583, 109.5643310546875], [-7.509621143341008, 109.564704895019531],
            [-7.509690284729004, 109.564979553222713], [-7.509752750396729, 109.565574645996207],
            [-7.509706497192383, 109.565780639648551], [-7.509688854217529, 109.565948486328239],
            [-7.509663105010986, 109.566177368164006], [-7.509678363800049, 109.566452026367244],
            [-7.509714603424072, 109.566818237304688], [-7.509742259979248, 109.567070007324276],
            [-7.509758472442627, 109.5673828125], [-7.509783267974797, 109.568061828613395],
            [-7.509825229644775, 109.568389892578182], [-7.509873867034912, 109.5687255859375],
            [-7.509962558746281, 109.569099426269531], [-7.510056972503605, 109.569297790527344],
            [-7.510135650634766, 109.569450378417969], [-7.51030778884882, 109.569709777832088],
            [-7.510542392730656, 109.569999694824162], [-7.510840415954533, 109.570281982421932],
            [-7.511256217956543, 109.570602416992188], [-7.511643886566162, 109.570846557617244],
            [-7.512007713317871, 109.571044921875057], [-7.512157917022705, 109.571113586425895],
            [-7.512547969818115, 109.571304321289176], [-7.512947082519474, 109.571540832519531],
            [-7.51311206817627, 109.571800231933651], [-7.513241767883301, 109.572105407714787],
            [-7.513293743133545, 109.572624206543082], [-7.513326644897461, 109.572937011718807],
            [-7.513316154479924, 109.573287963867188], [-7.513294696807861, 109.573898315429744],
            [-7.51324987411499, 109.574462890625057], [-7.513217449188232, 109.575157165527287],
            [-7.513180732726994, 109.576004028320369], [-7.513196945190373, 109.5765380859375],
            [-7.513236045837346, 109.577438354492131], [-7.513237476348877, 109.577919006347713],
            [-7.5132737159729, 109.578292846679744], [-7.513344287872258, 109.578887939453182],
            [-7.513429641723633, 109.579345703124943], [-7.513490200042668, 109.579978942871094],
            [-7.513503074645939, 109.580398559570369], [-7.513469696044922, 109.580879211425724],
            [-7.513406753539982, 109.581367492675838], [-7.513327121734505, 109.581626892089787],
            [-7.513313293457031, 109.582077026367188], [-7.513270378112793, 109.58245849609375],
            [-7.513441562652588, 109.583030700683594], [-7.513558864593449, 109.583511352539176],
            [-7.513619422912598, 109.584228515625057], [-7.51362419128418, 109.584625244140682],
            [-7.513647079467773, 109.584907531738281], [-7.513690948486328, 109.585060119628849],
            [-7.514036178588867, 109.585845947265625], [-7.514932155609131, 109.585929870605526],
            [-7.515385627746525, 109.585784912109489], [-7.515923976898193, 109.58560943603527],
            [-7.517124176025391, 109.585136413574219], [-7.518302440643254, 109.584671020507926],
            [-7.51946496963501, 109.584281921386832], [-7.52031946182251, 109.583999633789119],
            [-7.52272176742548, 109.584075927734489], [-7.528032779693604, 109.58319091796875],
            [-7.528139114379883, 109.583175659179688], [-7.528320312499943, 109.583091735839901],
            [-7.528608322143555, 109.582962036132756], [-7.529088497161865, 109.582138061523494],
            [-7.529302597045842, 109.581123352050781], [-7.529393672943058, 109.580696105957031],
            [-7.529412746429387, 109.580604553222713], [-7.529471874237061, 109.580322265625],
            [-7.529544830322209, 109.579612731933651], [-7.529871463775635, 109.576438903808707],
            [-7.5298814773559, 109.576339721679688], [-7.530647277832031, 109.572502136230469],
            [-7.531226634979248, 109.563049316406307], [-7.531715869903564, 109.562835693359432],
            [-7.532435417175293, 109.563430786132869], [-7.532699108123722, 109.563591003418026],
            [-7.533228874206543, 109.563911437988281], [-7.533805847167969, 109.563926696777344],
            [-7.534188270568848, 109.563949584960938], [-7.534711360931396, 109.563842773437614],
            [-7.535206794738713, 109.563560485839844], [-7.535515785217285, 109.563125610351506],
            [-7.535740852355957, 109.56280517578125], [-7.535965919494572, 109.561889648437557],
            [-7.536057472228947, 109.561134338378963], [-7.536086082458496, 109.560943603515682],
            [-7.536280632019043, 109.559684753418082], [-7.536421298980713, 109.559501647949162],
            [-7.536531448364258, 109.559471130371207], [-7.536662101745605, 109.559425354003963],
            [-7.53694486618042, 109.559593200683651], [-7.537064552307129, 109.559906005859375],
            [-7.537095069885254, 109.559989929199276], [-7.537121295928841, 109.560058593750114],
            [-7.537242412567139, 109.560371398925838], [-7.537653923034611, 109.561004638671989],
            [-7.537925720214844, 109.560989379882926], [-7.538056373596135, 109.560981750488395],
            [-7.538526058197021, 109.560592651367244], [-7.538926124572697, 109.560264587402287],
            [-7.539223194122314, 109.558921813964957], [-7.539760112762394, 109.557769775390739],
            [-7.539919853210392, 109.557662963867188]
        ];

        // Calculate bounding box
        $lats = array_map(fn($p) => $p[0], $this->boundary);
        $lngs = array_map(fn($p) => $p[1], $this->boundary);
        $this->boundingBox = [
            'lat' => ['min' => min($lats), 'max' => max($lats)],
            'lng' => ['min' => min($lngs), 'max' => max($lngs)],
        ];
    }
    
    /**
     * Generate a random point that is guaranteed to be within the defined boundary polygon.
     */
    private function generateRandomPointInBoundary(): array
    {
        while (true) {
            $lat = $this->boundingBox['lat']['min'] + (mt_rand() / mt_getrandmax()) * ($this->boundingBox['lat']['max'] - $this->boundingBox['lat']['min']);
            $lng = $this->boundingBox['lng']['min'] + (mt_rand() / mt_getrandmax()) * ($this->boundingBox['lng']['max'] - $this->boundingBox['lng']['min']);

            if ($this->isPointInPolygon($lat, $lng, $this->boundary)) {
                return ['lat' => $lat, 'lng' => $lng];
            }
        }
    }

    /**
     * Ray-casting algorithm to check if a point is inside a polygon.
     */
    private function isPointInPolygon(float $lat, float $lng, array $polygon): bool
    {
        $intersections = 0;
        $vertexCount = count($polygon);

        for ($i = 0, $j = $vertexCount - 1; $i < $vertexCount; $j = $i++) {
            $p1 = $polygon[$i];
            $p2 = $polygon[$j];

            if ((($p1[0] > $lat) != ($p2[0] > $lat)) &&
                ($lng < ($p2[1] - $p1[1]) * ($lat - $p1[0]) / ($p2[0] - $p1[0]) + $p1[1])) {
                $intersections++;
            }
        }
        return ($intersections % 2) != 0;
    }

    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        DB::table('infrastruktur')->delete();

        // Ambil desa pertama yang ada
        $desa = Desa::first();

        if (!$desa) {
            // Jika tidak ada desa, log error atau return
            return;
        }

        $point = $this->generateRandomPointInBoundary();
        $line = [$this->generateRandomPointInBoundary(), $this->generateRandomPointInBoundary(), $this->generateRandomPointInBoundary()];

        $infrastructures = [
            [
                'desa_id' => $desa->id,
                'nama' => 'Jalan Utama Desa',
                'jenis' => 'jalan',
                'kondisi' => 'baik',
                'panjang' => 2500.00,
                'koordinat' => json_encode([
                    'type' => 'LineString',
                    'coordinates' => array_map(fn($p) => [$p['lng'], $p['lat']], $line),
                ]),
                'keterangan' => 'Jalan aspal hotmix',
            ],
            [
                'desa_id' => $desa->id,
                'nama' => 'Jembatan Somagede',
                'jenis' => 'jembatan',
                'kondisi' => 'baik',
                'panjang' => 45.00,
                'koordinat' => json_encode([
                    'type' => 'Point',
                    'coordinates' => [$point['lng'], $point['lat']],
                ]),
                'keterangan' => 'Jembatan beton utama',
            ],
            [
                'desa_id' => $desa->id,
                'nama' => 'Saluran Irigasi Primer',
                'jenis' => 'irigasi',
                'kondisi' => 'rusak_ringan',
                'panjang' => 1800.00,
                 'koordinat' => json_encode([
                    'type' => 'LineString',
                    'coordinates' => array_map(fn($p) => [$p['lng'], $p['lat']], $line),
                ]),
                'keterangan' => 'Perlu perbaikan di beberapa bagian sisi utara.',
            ],
        ];

        foreach ($infrastructures as $infrastructure) {
            DB::table('infrastruktur')->insert(array_merge($infrastructure, [
                'created_at' => now(),
                'updated_at' => now(),
            ]));
        }
    }
}
